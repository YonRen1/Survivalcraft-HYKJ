using System.Linq;
using Game;
using Engine.Serialization;
using System.Xml.Linq;
using Engine;
using System;
using Engine.Media;
using Random = Game.Random;
using Engine.Graphics;
using GameEntitySystem;
using System.Collections.Generic;
using System.Globalization;
using TemplatesDatabase;
using System.Reflection;
using System.IO;
using System.Runtime.CompilerServices;
using System.Threading;
using XmlUtilities;
using Engine.Input;
using System.Text;
using System.Threading.Tasks;
//———————————————————————荒野科技——————————————————————— 
namespace HYKJ
{
    public class HYKJModLoader : ModLoader
    {
        public static ReadOnlyList<string> Categories => new(m_categories);

        public static List<string> m_categories = [];

        private bool isSprintChecked = false;

        public GameMode gameMode;

        public ComponentGui m_componentGui;

        public static Subtexture ToSubtexture(string imgpath, Vector2? TopLeft = null, Vector2? BottomRight = null)
        {
            return new Subtexture(ContentManager.Get<Texture2D>(imgpath), TopLeft ?? Vector2.Zero, BottomRight ?? Vector2.One);
        }

        public override void __ModInitialize()
        {
            ModsManager.RegisterHook("GuiUpdate", this);
            ModsManager.RegisterHook("OnMinerHit", this);
            ModsManager.RegisterHook("OnLoadingFinished", this);
            ModsManager.RegisterHook("BlocksInitalized", this);
        }

        /// <summary>
        /// Gui组件帧更新时执行
        /// </summary>
        /// <param name="componentGui"></param>
        public override void GuiUpdate(ComponentGui componentGui)
        {
            ComponentPlayer m_componentPlayer = componentGui.m_componentPlayer;//获取玩家组件
            CanvasWidget controlsContainer = m_componentPlayer.GuiWidget.Children.Find<CanvasWidget>("ControlsContainer");//屏幕总控件容器
            StackPanelWidget leftContainer = m_componentPlayer.GuiWidget.Children.Find<StackPanelWidget>("LeftControlsContainer");//屏幕左侧控件容器       
            StackPanelWidget lightContainer = m_componentPlayer.GuiWidget.Children.Find<StackPanelWidget>("RightControlsContainer");//屏幕右侧控件容器
            StackPanelWidget moreContents = m_componentPlayer.GuiWidget.Children.Find<StackPanelWidget>("MoreContents");//屏幕右侧最顶隐藏容器
            StackPanelWidget statusContents = (StackPanelWidget)m_componentPlayer.GuiWidget.Children.Find<ValueBarWidget>("TemperatureBar").ParentWidget; //玩家生存模式状态栏容器 //获取父类容器
            controlsContainer = m_componentPlayer.GuiWidget.Children.Find<CanvasWidget>("ControlsContainer");
            ComponentThirst componentThirst = m_componentPlayer.Entity.FindComponent<ComponentThirst>(true);
            //疾跑按钮
            sprint.AddChildren(sprintImg); //给空白按钮添加图标
            lightContainer.AddChildren(sprint);
            //属性按钮
            attribute.AddChildren(attribute_one); //给空白按钮添加图标
            leftContainer.AddChildren(attribute);
            //耐力条
            statusContents.AddChildren(staminaBar);
            //水分条
            statusContents.AddChildren(Water);
            //工具按钮
            moreContents.AddChildren(tool);

            if (tool != null)
            {
                tool.Text = "";
            }
            if (attribute != null)
            {
                attribute.Text = "";
            }
            if (sprint != null)
            {
                sprint.Text = "";
            }

            //点击事件
            if (tool.IsClicked)
            {
                m_componentPlayer.ComponentGui.ModalPanelWidget = new ToolWidget(m_componentPlayer);
            }
            if (attribute.IsClicked)
            {
                m_componentPlayer.ComponentGui.ModalPanelWidget = new HYKJClothingWidget(m_componentPlayer);
            }
            //耐力
            if (staminaBar.IsVisible)
            {
                staminaBar.Value = m_componentPlayer.ComponentVitalStats.Stamina;
            }
            if (Water.IsVisible)
            {
                Water.Value = componentThirst.Water;
            }
            //跑步
            if (sprint.IsClicked)
            {
                isSprintChecked = (isSprintChecked) ? false : true;
                if (isSprintChecked)
                {
                    m_componentPlayer.ComponentLocomotion.WalkSpeed += 1.0f;
                    componentGui.DisplaySmallMessage("开始疾跑", Color.White, false, false);
                }
                else
                {
                    m_componentPlayer.ComponentLocomotion.WalkSpeed -= 1.0f;
                    componentGui.DisplaySmallMessage("停止疾跑", Color.White, false, false);
                }
            }
            //获取游戏难度
            gameMode = m_componentGui.m_subsystemGameInfo.WorldSettings.GameMode;
            //控件是否显示
            staminaBar.IsVisible = gameMode != GameMode.Creative;
        }

        /// <summary>
        /// 加载任务结束时执行
        /// 在BlocksManager初始化之后
        /// </summary>
        /// <param name="actions"></param>
        public override void OnLoadingFinished(List<Action> actions)
        {
            actions.Add(delegate ()
            {
                ScreensManager.m_screens["MainMenu"] = new HYKJMainMenuScreen();//覆盖原版
            });
        }

        /// <summary>
        /// 方块初始化完成时执行
        /// </summary>
        /*public override void BlocksInitalized()
        {
            BlocksManager.m_categories.Clear();
            BlocksManager.m_categories.Add("Terrain");
            BlocksManager.m_categories.Add("Minerals");
            BlocksManager.m_categories.Add("Plants");
            BlocksManager.m_categories.Add("Construction");
            BlocksManager.m_categories.Add("Items");
            BlocksManager.m_categories.Add("荒野科技材料");
            BlocksManager.m_categories.Add("Tools");
            BlocksManager.m_categories.Add("荒野科技工具");
            BlocksManager.m_categories.Add("Weapons");
            BlocksManager.m_categories.Add("荒野科技武器");
            BlocksManager.m_categories.Add("Clothes");
            BlocksManager.m_categories.Add("Electrics");
            BlocksManager.m_categories.Add("Food");
            BlocksManager.m_categories.Add("Spawner Eggs");
            BlocksManager.m_categories.Add("Painted");
            BlocksManager.m_categories.Add("Dyed");
            BlocksManager.m_categories.Add("Fireworks");
        }*/
        //定义新的按钮：工具按钮
        private BitmapButtonWidget tool = new BitmapButtonWidget
        {
            Name = "toolButton",
            Size = new Vector2(68f, 64f),
            NormalSubtexture = ToSubtexture("HYKJTextures/Button/tool"),
            ClickedSubtexture = ToSubtexture("HYKJTextures/Button/tool_Pressed"),
            //Text = "",
            Margin = new Vector2(4, 0),
        };
        //定义新的按钮：属性按钮
        private BitmapButtonWidget attribute = new BitmapButtonWidget
        {
            Name = "attributeButton",
            Size = new Vector2(68f, 64f),
            NormalSubtexture = ToSubtexture("HYKJTextures/Button/BlankLightButton_1"),
            ClickedSubtexture = ToSubtexture("HYKJTextures/Button/BlankLightButton_Pressed_1"),
            //Text = "",
            //Margin = new Vector2(4, 0),
        };
        //属性图像
        private RectangleWidget attribute_one = new RectangleWidget
        {
            Size = new Vector2(45f, 45f),
            OutlineColor = new Color(0, 0, 0, 0),
            FillColor = new Color(255, 255, 255),
            Subtexture = ToSubtexture("HYKJTextures/Button/attribute"),
            //居中
            HorizontalAlignment = WidgetAlignment.Center,
            VerticalAlignment = WidgetAlignment.Center,
        };
        //跑步
        private BitmapButtonWidget sprint = new BitmapButtonWidget
        {
            Name = "SprintButton",
            Size = new Vector2(64f, 64f),
            HorizontalAlignment = WidgetAlignment.Far,
            NormalSubtexture = ToSubtexture("HYKJTextures/Button/BlankLightButton"),
            ClickedSubtexture = ToSubtexture("HYKJTextures/Button/BlankLightButton_Pressed"),
            Margin = new Vector2(0, 3), //外边距
            //开启自动选中
            IsAutoCheckingEnabled = true,
        };
        //模组信息
        /* private BitmapButtonWidget mod = new BitmapButtonWidget
         {
             Name = "mod",
             Style = ContentManager.Get<XElement>("Styles/ButtonStyle_310x60"),
             HorizontalAlignment = WidgetAlignment.Far,
             Margin = new Vector2(0, 3), //外边距
         };*/
        //跑步
        private RectangleWidget sprintImg = new RectangleWidget
        {
            Size = new Vector2(40f, 40f),
            OutlineColor = new Color(0, 0, 0, 0),
            FillColor = new Color(255, 255, 255),
            Subtexture = ToSubtexture("HYKJTextures/Button/Sprint"),
            //居中
            HorizontalAlignment = WidgetAlignment.Center,
            VerticalAlignment = WidgetAlignment.Center,
        };
        //耐力
        private ValueBarWidget staminaBar = new ValueBarWidget
        {
            Name = "StaminaBar",
            BarSize = new Vector2(16f, 16f), //条大小
            LitBarColor = new Color(220, 241, 37),
            UnlitBarColor = new Color(0, 0, 0, 255),
            //条显示图标
            BarSubtexture = ToSubtexture("HYKJTextures/Button/Stamina"),
            BarsCount = 10, //条图标个数
            BarBlending = false,
            HalfBars = true,
            TextureLinearFilter = true,
        };
        //耐力
        private ValueBarWidget Water = new ValueBarWidget
        {
            Name = "Water",
            BarSize = new Vector2(16f, 16f), //条大小
            LitBarColor = new Color(0, 149, 255),
            UnlitBarColor = new Color(0, 0, 0, 255),
            //条显示图标
            BarSubtexture = ToSubtexture("HYKJTextures/Button/Water"),
            BarsCount = 10, //条图标个数
            BarBlending = false,
            HalfBars = true,
            TextureLinearFilter = true,
        };
    }

}